<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MCMCVisualizer Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.plot.ly/plotly-2.35.0.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --sidebar-w: 360px;
      --bg-primary: #0c0e14;
      --bg-secondary: #13151e;
      --bg-sidebar: #111320;
      --bg-card: #181b26;
      --border: #262a3a;
      --border-light: #2f3447;
      --text-primary: #eaedf3;
      --text-secondary: #9399ab;
      --text-muted: #5c6278;
      --accent: #6366f1;
      --accent-hover: #818cf8;
      --accent-subtle: rgba(99, 102, 241, 0.08);
      --success: #34d399;
      --error: #f87171;
      --radius: 12px;
      --radius-sm: 8px;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.3), 0 1px 2px rgba(0,0,0,0.2);
      --shadow-md: 0 4px 14px rgba(0,0,0,0.35);
      --transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      height: 100vh;
      overflow: hidden;
    }

    *::-webkit-scrollbar { width: 5px; height: 5px; }
    *::-webkit-scrollbar-track { background: transparent; }
    *::-webkit-scrollbar-thumb { background: rgba(99,102,241,0.18); border-radius: 4px; }
    *::-webkit-scrollbar-thumb:hover { background: rgba(99,102,241,0.32); }
    @supports (scrollbar-width: thin) {
      * { scrollbar-width: thin; scrollbar-color: rgba(99,102,241,0.18) transparent; }
    }

    /* ── Two-panel shell ── */
    .shell {
      display: grid;
      grid-template-columns: var(--sidebar-w) 1fr;
      height: 100vh;
      overflow: hidden;
    }

    /* ── Left sidebar ── */
    .sidebar {
      background: var(--bg-sidebar);
      border-right: 1px solid var(--border);
      padding: 32px 24px;
      display: flex;
      flex-direction: column;
      gap: 0;
      overflow-y: auto;
      position: sticky;
      top: 0;
      height: 100vh;
    }

    .brand {
      margin-bottom: 28px;
      flex-shrink: 0;
    }
    .brand h1 {
      font-size: 1.35rem;
      font-weight: 700;
      letter-spacing: -0.02em;
      margin-bottom: 4px;
      background: linear-gradient(135deg, #eaedf3, #9399ab);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .brand p {
      color: var(--text-muted);
      font-size: 0.78rem;
      line-height: 1.5;
    }

    /* Sidebar section labels */
    .sidebar-label {
      font-size: 0.68rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-muted);
      margin: 20px 0 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .sidebar-label .dot {
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: var(--accent);
    }

    /* Drop zone */
    #drop-zone {
      border: 2px dashed var(--border);
      border-radius: var(--radius);
      padding: 28px 16px;
      text-align: center;
      transition: all var(--transition);
      cursor: pointer;
      background: var(--bg-secondary);
      position: relative;
      overflow: hidden;
      flex-shrink: 0;
    }
    #drop-zone.compact {
      padding: 10px 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      text-align: left;
    }
    #drop-zone.compact .drop-icon { display: none; }
    #drop-zone.compact h3 { font-size: 0.75rem; margin: 0; }
    #drop-zone.compact span { display: none; }
    #drop-zone::before {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(ellipse at center, rgba(99,102,241,0.04), transparent 70%);
      pointer-events: none;
    }
    #drop-zone:hover, #drop-zone:focus-visible {
      border-color: var(--border-light);
      background: var(--bg-card);
    }
    #drop-zone.hover {
      border-color: var(--accent);
      background: rgba(99, 102, 241, 0.04);
      box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.08);
    }
    .drop-icon { font-size: 1.6rem; margin-bottom: 6px; opacity: 0.35; }
    #drop-zone h3 { font-size: 0.82rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 4px; }
    #drop-zone span { font-size: 0.7rem; color: var(--text-muted); display: block; }
    #file-input { display: none; }

    #status {
      font-size: 0.74rem;
      color: var(--success);
      min-height: 1.2em;
      font-weight: 500;
      margin-top: 8px;
    }
    #status.err { color: var(--error); }

    /* Buttons & controls in sidebar */
    .actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 4px;
      flex-shrink: 0;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: var(--radius-sm);
      padding: 10px 18px;
      font-size: 0.82rem;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition);
      box-shadow: 0 2px 8px rgba(99,102,241,0.25);
      font-family: inherit;
      width: 100%;
    }
    .btn:hover {
      background: var(--accent-hover);
      box-shadow: 0 4px 16px rgba(99,102,241,0.35);
      transform: translateY(-1px);
    }
    .btn:active { transform: translateY(0); }

    .field { display: flex; flex-direction: column; gap: 4px; }
    .field label {
      font-size: 0.7rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.8px;
      font-weight: 600;
    }
    .field select {
      appearance: none;
      background: var(--bg-card) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%239399ab' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E") no-repeat right 10px center;
      color: var(--text-primary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 9px 32px 9px 12px;
      font-size: 0.82rem;
      font-family: inherit;
      cursor: pointer;
      transition: all var(--transition);
      width: 100%;
    }
    .field select:hover { border-color: var(--border-light); }
    .field select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(99,102,241,0.12); }

    /* Summary in sidebar */
    #summary-wrap {
      flex: 1;
      overflow-y: auto;
      margin-top: 4px;
    }
    #summary-wrap::-webkit-scrollbar { display: none; }
    @supports (scrollbar-width: none) {
      #summary-wrap { scrollbar-width: none; }
    }
    #summary-wrap #summary { font-size: 0.78rem; }
    #summary-wrap table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
    #summary-wrap th, #summary-wrap td { padding: 5px 6px; text-align: left; border-bottom: 1px solid var(--border); }
    #summary-wrap th { color: var(--text-muted); font-weight: 600; text-transform: uppercase; font-size: 0.65rem; letter-spacing: 0.5px; }

    /* Export in sidebar */
    .export-bar {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 4px;
      flex-shrink: 0;
    }
    .export-bar button {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: var(--bg-secondary);
      color: var(--text-secondary);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 5px 10px;
      font-size: 0.7rem;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition);
      font-family: inherit;
    }
    .export-bar button:hover {
      border-color: var(--accent);
      color: var(--text-primary);
      background: var(--accent-subtle);
    }
    .export-bar button::before { content: '\2193'; font-size: 0.8rem; opacity: 0.4; }

    .sidebar-footer {
      margin-top: auto;
      padding-top: 20px;
      text-align: center;
      color: var(--text-muted);
      font-size: 0.68rem;
      letter-spacing: 0.3px;
      flex-shrink: 0;
    }

    /* ── Right main content ── */
    .main {
      padding: 28px 32px;
      overflow-y: auto;
      height: 100vh;
    }

    .main-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 24px;
    }
    .main-header h2 {
      font-size: 1.1rem;
      font-weight: 600;
      letter-spacing: -0.01em;
    }
    .main-header .pill {
      background: var(--accent-subtle);
      border: 1px solid rgba(99,102,241,0.15);
      color: var(--accent-hover);
      font-size: 0.68rem;
      font-weight: 600;
      padding: 3px 10px;
      border-radius: 100px;
    }

    .section-label {
      font-size: 0.72rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-muted);
      margin: 28px 0 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .section-label:first-of-type { margin-top: 0; }
    .section-label .dot {
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: var(--accent);
    }

    .plot-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 8px;
    }
    .plot-grid.single { grid-template-columns: 1fr; }

    .plot-cell {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      min-height: 360px;
      transition: border-color var(--transition), box-shadow var(--transition);
    }
    .plot-cell:hover {
      border-color: var(--border-light);
      box-shadow: var(--shadow-md);
    }
    .plot-cell.tall { min-height: 460px; }

    #app { display: none; }
    .hidden { display: none; }

    /* ── Responsive: iPad landscape / small desktop ── */
    @media (max-width: 1100px) {
      :root { --sidebar-w: 300px; }
    }

    /* ── Responsive: iPad portrait / tablets ── */
    @media (max-width: 960px) {
      .shell {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
        height: auto;
        overflow: visible;
      }
      body { overflow: auto; height: auto; }
      .sidebar {
        position: relative;
        height: auto;
        border-right: none;
        border-bottom: 1px solid var(--border);
        padding: 24px 20px;
      }
      .main { padding: 24px 20px; height: auto; overflow: visible; }
      .plot-grid { grid-template-columns: 1fr 1fr; }
    }

    /* ── Responsive: mobile ── */
    @media (max-width: 640px) {
      .sidebar { padding: 20px 16px; }
      .main { padding: 20px 16px; }
      .brand h1 { font-size: 1.15rem; }
      .brand p { font-size: 0.72rem; }
      .plot-grid { grid-template-columns: 1fr; }
      .plot-cell { min-height: 280px; }
      .plot-cell.tall { min-height: 340px; }
      .main-header h2 { font-size: 0.95rem; }
      .export-bar { gap: 4px; }
      .export-bar button { padding: 4px 8px; font-size: 0.65rem; }
    }
  </style>
</head>
<body>
  <div class="shell">
    <!-- ── Left Sidebar ── -->
    <aside class="sidebar">
      <div class="brand">
        <h1>MCMCVisualizer</h1>
        <p>Upload MCMC output or generate synthetic data to explore diagnostics.</p>
      </div>

      <div id="drop-zone" tabindex="0">
        <div class="drop-icon">&#8693;</div>
        <h3>Drop file here or click to browse</h3>
        <span>Turing CSV &middot; Stan CSV &middot; MCMCChains JSON</span>
        <input type="file" id="file-input" accept=".csv,.json,.txt">
      </div>

      <div class="actions">
        <button class="btn" id="btn-demo">&#9654; Load Demo Data</button>
        <div class="field">
          <label for="var-select">Variable</label>
          <select id="var-select"><option disabled selected>Load data first</option></select>
        </div>
      </div>
      <div id="status"></div>

      <div id="app-sidebar" class="hidden">
        <div class="sidebar-label"><span class="dot"></span> Summary Statistics</div>
        <div id="summary-wrap">
          <div id="summary"></div>
        </div>

        <div class="sidebar-label"><span class="dot"></span> Export</div>
        <div class="export-bar">
          <button data-fmt="turing">Turing CSV</button>
          <button data-fmt="mcmcchains-csv">MCMCChains CSV</button>
          <button data-fmt="stan">Stan CSV</button>
          <button data-fmt="wide">Wide CSV</button>
          <button data-fmt="json">JSON</button>
          <button data-fmt="mcmcchains-json">MCMCChains JSON</button>
        </div>
      </div>

      <div class="sidebar-footer">MCMCVisualizer &mdash; Built for Bayesian workflows</div>
    </aside>

    <!-- ── Right Main Content ── -->
    <main class="main">
      <div class="main-header">
        <h2>Diagnostics</h2>
        <span class="pill" id="data-info">No data loaded</span>
      </div>

      <div id="app">
        <span class="section-label"><span class="dot"></span> Per-Variable Diagnostics</span>
        <div class="plot-grid">
          <div class="plot-cell" id="trace"></div>
          <div class="plot-cell" id="hist"></div>
          <div class="plot-cell" id="acf"></div>
          <div class="plot-cell" id="cmean"></div>
        </div>

        <span class="section-label"><span class="dot"></span> Multi-Variable Diagnostics</span>
        <div class="plot-grid single">
          <div class="plot-cell tall" id="forest"></div>
          <div class="plot-cell tall" id="pairs"></div>
        </div>
      </div>
    </main>
  </div>

  <script type="module">
    import { fromChainArrays, fromAutoDetect, detectFormat, plots } from './dist/index.js';

    let currentData = null;
    const handles = [];

    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const statusEl = document.getElementById('status');
    const appEl = document.getElementById('app');
    const varSelect = document.getElementById('var-select');

    function status(msg, isErr) {
      statusEl.textContent = msg;
      statusEl.className = isErr ? 'err' : '';
    }

    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('hover'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('hover'));
    dropZone.addEventListener('drop', e => {
      e.preventDefault();
      dropZone.classList.remove('hover');
      const file = e.dataTransfer.files[0];
      if (file) readFile(file);
    });
    fileInput.addEventListener('change', () => {
      if (fileInput.files[0]) readFile(fileInput.files[0]);
    });

    function readFile(file) {
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const text = reader.result;
          const fmt = detectFormat(text);
          const data = fromAutoDetect(text);
          status(`Loaded ${file.name} (${fmt}, ${data.chainNames.length} chains, ${data.variableNames.length} vars, ${data.drawCount} draws)`);
          loadData(data);
        } catch (err) {
          status(`Error: ${err.message}`, true);
        }
      };
      reader.readAsText(file);
    }

    document.getElementById('btn-demo').addEventListener('click', () => {
      function rng(s) { return () => { s = (s * 1103515245 + 12345) & 0x7fffffff; return s / 0x7fffffff; }; }
      function norm(r) { return () => { let u = 0, v = 0; while (!u) u = r(); while (!v) v = r(); return Math.sqrt(-2 * Math.log(u)) * Math.cos(2 * Math.PI * v); }; }
      function walk(n, start, scale, seed) { const g = norm(rng(seed)); const a = [start]; for (let i = 1; i < n; i++) a.push(a[i - 1] + g() * scale); return a; }

      const data = fromChainArrays({
        'chain 1': { mu: walk(2000, 0, 0.15, 42), sigma: walk(2000, 1, 0.05, 123).map(Math.abs), beta: walk(2000, -2, 0.2, 777) },
        'chain 2': { mu: walk(2000, 0.1, 0.15, 99), sigma: walk(2000, 1.05, 0.05, 456).map(Math.abs), beta: walk(2000, -1.9, 0.2, 888) },
        'chain 3': { mu: walk(2000, -0.05, 0.15, 200), sigma: walk(2000, 0.95, 0.05, 300).map(Math.abs), beta: walk(2000, -2.1, 0.2, 400) },
      });
      status('Loaded synthetic demo data (3 chains, 3 vars, 2000 draws)');
      loadData(data);
    });

    varSelect.addEventListener('change', () => {
      const v = varSelect.value;
      for (const h of handles) h.update(v);
    });

    function loadData(data) {
      currentData = data;
      appEl.style.display = 'block';
      document.getElementById('app-sidebar').classList.remove('hidden');
      document.getElementById('data-info').textContent =
        `${data.chainNames.length} chains \u00b7 ${data.variableNames.length} vars \u00b7 ${data.drawCount} draws`;

      dropZone.classList.add('compact');
      dropZone.querySelector('h3').textContent = 'Drop or click to load another file';

      varSelect.innerHTML = '';
      for (const v of data.variableNames) {
        const opt = document.createElement('option');
        opt.value = v; opt.textContent = v;
        varSelect.appendChild(opt);
      }

      for (const h of handles) h.destroy();
      handles.length = 0;

      const firstVar = data.variableNames[0];
      const plotH = 370;
      const tallH = 450;
      handles.push(plots.summaryTable(document.getElementById('summary'), data));
      handles.push(plots.tracePlot(document.getElementById('trace'), data, firstVar, { height: plotH }));
      handles.push(plots.histogramPlot(document.getElementById('hist'), data, firstVar, { height: plotH }));
      handles.push(plots.autocorrelationPlot(document.getElementById('acf'), data, firstVar, { height: plotH }));
      handles.push(plots.cumulativeMeanPlot(document.getElementById('cmean'), data, firstVar, { height: plotH }));
      handles.push(plots.forestPlot(document.getElementById('forest'), data, { height: tallH }));
      handles.push(plots.pairPlot(document.getElementById('pairs'), data, undefined, { height: tallH }));
    }

    function download(content, filename) {
      const blob = new Blob([content], { type: 'text/plain' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    for (const btn of document.querySelectorAll('.export-bar button')) {
      btn.addEventListener('click', () => {
        if (!currentData) return;
        const fmt = btn.dataset.fmt;
        const exports = {
          'turing':           () => download(currentData.toTuringCSV(), 'mcmc_turing.csv'),
          'mcmcchains-csv':   () => download(currentData.toMCMCChainsCSV(), 'mcmc_chains.csv'),
          'stan':             () => download(currentData.toStanCSV(), 'mcmc_stan.csv'),
          'wide':             () => download(currentData.toWideCSV(), 'mcmc_wide.csv'),
          'json':             () => download(currentData.toJSON(), 'mcmc_data.json'),
          'mcmcchains-json':  () => download(currentData.toMCMCChainsJSON(), 'mcmc_chains.json'),
        };
        exports[fmt]?.();
        status(`Exported as ${fmt}`);
      });
    }
  </script>
</body>
</html>
